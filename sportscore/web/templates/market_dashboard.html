{% extends "base.html" %}

{% block title %}Market Dashboard{% endblock %}

{% block styles %}
<style>
    .dashboard-header {
        margin-bottom: 30px;
    }

    .dashboard-header h1 {
        margin-bottom: 5px;
    }

    .dashboard-subtitle {
        color: #666;
        font-size: 0.95em;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        padding: 20px;
        color: white;
    }

    .stat-card.green {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }

    .stat-card.red {
        background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
    }

    .stat-card.blue {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .stat-card.orange {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .stat-card.dark {
        background: linear-gradient(135deg, #434343 0%, #000000 100%);
    }

    .stat-label {
        font-size: 0.85em;
        opacity: 0.9;
        margin-bottom: 5px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stat-value {
        font-size: 1.8em;
        font-weight: 700;
    }

    .stat-subtext {
        font-size: 0.8em;
        opacity: 0.8;
        margin-top: 5px;
    }

    .chart-section {
        margin-bottom: 30px;
    }

    .chart-container {
        background: #f9f9f9;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        height: 350px;
        position: relative;
    }

    .chart-title {
        font-size: 1.1em;
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
    }

    .chart-wrapper {
        position: relative;
        height: 280px;
        width: 100%;
    }

    .tables-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    @media (max-width: 900px) {
        .tables-section {
            grid-template-columns: 1fr;
        }
    }

    .table-container {
        background: #f9f9f9;
        border-radius: 12px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        max-height: 400px;
    }

    .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        flex-shrink: 0;
    }

    .table-title {
        font-size: 1.1em;
        font-weight: 600;
        color: #333;
    }

    .expand-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        color: #666;
        transition: all 0.2s;
    }

    .expand-btn:hover {
        background: #e0e0e0;
        color: #333;
    }

    .table-scroll-wrapper {
        flex: 1;
        overflow-y: auto;
        min-height: 0;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9em;
    }

    .data-table thead {
        position: sticky;
        top: 0;
        background: #f9f9f9;
        z-index: 1;
    }

    .load-more-row td {
        text-align: center;
        padding: 15px;
        color: #666;
    }

    .loading-more {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #ddd;
        border-top-color: #667eea;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin-right: 8px;
        vertical-align: middle;
    }

    /* Expanded table modal */
    .table-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        align-items: center;
        justify-content: center;
        padding: 40px;
    }

    .table-modal.active {
        display: flex;
    }

    .table-modal-content {
        background: white;
        border-radius: 12px;
        width: 100%;
        max-width: 900px;
        height: 100%;
        max-height: calc(100vh - 80px);
        display: flex;
        flex-direction: column;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    .table-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #eee;
        flex-shrink: 0;
    }

    .table-modal-title {
        font-size: 1.3em;
        font-weight: 600;
        color: #333;
    }

    .table-modal-close {
        background: none;
        border: none;
        font-size: 28px;
        cursor: pointer;
        color: #666;
        padding: 0;
        line-height: 1;
    }

    .table-modal-close:hover {
        color: #333;
    }

    .table-modal-body {
        flex: 1;
        overflow-y: auto;
        padding: 0;
        min-height: 0;
    }

    .table-modal-body .data-table {
        font-size: 0.95em;
    }

    .table-modal-body .data-table th,
    .table-modal-body .data-table td {
        padding: 12px 16px;
    }

    .table-modal-body .data-table thead {
        position: sticky;
        top: 0;
        background: white;
        z-index: 1;
    }

    .data-table th {
        text-align: left;
        padding: 10px 8px;
        border-bottom: 2px solid #ddd;
        color: #666;
        font-weight: 600;
    }

    .data-table td {
        padding: 10px 8px;
        border-bottom: 1px solid #eee;
    }

    .data-table tr:hover {
        background: #f0f0f0;
    }

    .positive {
        color: #11998e;
        font-weight: 600;
    }

    .negative {
        color: #eb3349;
        font-weight: 600;
    }

    .ticker {
        font-family: 'Courier New', monospace;
        font-size: 0.85em;
        background: #e0e0e0;
        padding: 2px 6px;
        border-radius: 4px;
    }

    .loading-container {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 60px;
        color: #666;
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 15px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .error-message {
        background: #fff5f5;
        border: 1px solid #feb2b2;
        color: #c53030;
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .refresh-btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: background 0.2s;
    }

    .refresh-btn:hover {
        background: #5a67d8;
    }

    .header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-header">
    <div class="header-row">
        <div>
            <h1>Market Dashboard</h1>
            <p class="dashboard-subtitle">Trading performance and portfolio overview</p>
        </div>
        <button class="refresh-btn" onclick="loadDashboardData(true)">Refresh Data</button>
    </div>
</div>

<div id="dashboard-content">
    <div class="loading-container">
        <div class="loading-spinner"></div>
        <span>Loading market data...</span>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let returnsChart = null;
let cumulativeChart = null;

// Pagination state
let fillsCursor = null;
let settlementsCursor = null;
let loadingFills = false;
let loadingSettlements = false;
let hasMoreFills = true;
let hasMoreSettlements = true;

function formatCurrency(cents) {
    const dollars = cents / 100;
    return '$' + dollars.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function formatPercent(value) {
    return (value >= 0 ? '+' : '') + value.toFixed(2) + '%';
}

function renderFillRow(fill) {
    const date = new Date(fill.created_time).toLocaleDateString();
    const side = (fill.side || '').toUpperCase();
    const action = (fill.action || 'buy').toUpperCase();
    return `
        <tr>
            <td>${date}</td>
            <td><span class="ticker">${fill.ticker}</span></td>
            <td>${action} ${side}</td>
            <td>${fill.count}</td>
            <td>${fill.price}c</td>
            <td>${formatCurrency(fill.cost)}</td>
        </tr>
    `;
}

function renderSettlementRow(s) {
    const date = new Date(s.settled_time).toLocaleDateString();
    const cost = (s.yes_total_cost || 0) + (s.no_total_cost || 0);
    const pnl = (s.revenue || 0) - cost;
    const pnlClass = pnl >= 0 ? 'positive' : 'negative';
    const result = pnl > 0 ? 'Won' : pnl < 0 ? 'Lost' : 'Break Even';
    return `
        <tr>
            <td>${date}</td>
            <td><span class="ticker">${s.ticker}</span></td>
            <td class="${pnlClass}">${result}</td>
            <td class="${pnlClass}">${formatCurrency(pnl)}</td>
        </tr>
    `;
}

async function loadDashboardData(refresh = false) {
    const content = document.getElementById('dashboard-content');
    content.innerHTML = `
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <span>${refresh ? 'Refreshing market data...' : 'Loading market data...'}</span>
        </div>
    `;

    try {
        const url = refresh ? '/api/market/dashboard?refresh=1' : '/api/market/dashboard';
        const response = await fetch(url);
        const data = await response.json();

        if (!data.success) {
            throw new Error(data.error || 'Failed to load dashboard data');
        }

        renderDashboard(data);
    } catch (error) {
        content.innerHTML = `
            <div class="error-message">
                <strong>Error:</strong> ${error.message}
            </div>
        `;
    }
}

function renderDashboard(data) {
    const content = document.getElementById('dashboard-content');
    const stats = data.stats;
    const fills = data.recent_fills || [];
    const settlements = data.recent_settlements || [];

    // Store pagination state
    fillsCursor = data.fills_cursor || null;
    settlementsCursor = data.settlements_cursor || null;
    hasMoreFills = !!fillsCursor;
    hasMoreSettlements = !!settlementsCursor;

    const totalReturnClass = stats.total_return_cents >= 0 ? 'green' : 'red';
    const return24hClass = stats.return_24h_cents >= 0 ? 'green' : 'red';
    const return7dClass = stats.return_7d_cents >= 0 ? 'green' : 'red';
    const return30dClass = stats.return_30d_cents >= 0 ? 'green' : 'red';
    const roiClass = stats.roi >= 0 ? 'positive' : 'negative';

    content.innerHTML = `
        <div class="stats-grid">
            <div class="stat-card blue">
                <div class="stat-label">Account Balance</div>
                <div class="stat-value">${formatCurrency(stats.balance_cents)}</div>
                <div class="stat-subtext">Available for trading</div>
            </div>
            <div class="stat-card ${totalReturnClass}">
                <div class="stat-label">Total Return</div>
                <div class="stat-value">${formatCurrency(stats.total_return_cents)}</div>
                <div class="stat-subtext">All-time P&L</div>
            </div>
            <div class="stat-card ${return24hClass}">
                <div class="stat-label">24 Hour Return</div>
                <div class="stat-value">${formatCurrency(stats.return_24h_cents)}</div>
                <div class="stat-subtext">Last 24 hours</div>
            </div>
            <div class="stat-card ${return7dClass}">
                <div class="stat-label">7 Day Return</div>
                <div class="stat-value">${formatCurrency(stats.return_7d_cents)}</div>
                <div class="stat-subtext">Last 7 days</div>
            </div>
            <div class="stat-card ${return30dClass}">
                <div class="stat-label">30 Day Return</div>
                <div class="stat-value">${formatCurrency(stats.return_30d_cents)}</div>
                <div class="stat-subtext">Last 30 days</div>
            </div>
            <div class="stat-card dark">
                <div class="stat-label">Total Invested</div>
                <div class="stat-value">${formatCurrency(stats.total_invested_cents)}</div>
                <div class="stat-subtext">Cumulative cost basis</div>
            </div>
            <div class="stat-card orange">
                <div class="stat-label">ROI</div>
                <div class="stat-value">${formatPercent(stats.roi)}</div>
                <div class="stat-subtext">Return on investment</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Trades</div>
                <div class="stat-value">${stats.total_trades.toLocaleString()}</div>
                <div class="stat-subtext">${stats.winning_trades} wins / ${stats.losing_trades} losses</div>
            </div>
            <div class="stat-card ${stats.win_rate >= 50 ? 'green' : 'red'}">
                <div class="stat-label">Win Rate</div>
                <div class="stat-value">${stats.win_rate.toFixed(1)}%</div>
                <div class="stat-subtext">Settled positions</div>
            </div>
        </div>

        <div class="chart-section">
            <div class="chart-container">
                <div class="chart-title">Cumulative Returns Over Time</div>
                <div class="chart-wrapper">
                    <canvas id="cumulativeChart"></canvas>
                </div>
            </div>
        </div>

        <div class="tables-section">
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">Recent Fills</div>
                    <button class="expand-btn" onclick="openTableModal('fills')" title="Expand">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="15 3 21 3 21 9"></polyline>
                            <polyline points="9 21 3 21 3 15"></polyline>
                            <line x1="21" y1="3" x2="14" y2="10"></line>
                            <line x1="3" y1="21" x2="10" y2="14"></line>
                        </svg>
                    </button>
                </div>
                <div class="table-scroll-wrapper" id="fills-scroll-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Ticker</th>
                                <th>Side</th>
                                <th>Qty</th>
                                <th>Price</th>
                                <th>Cost</th>
                            </tr>
                        </thead>
                        <tbody id="fills-table-body">
                            ${fills.length === 0 ? '<tr><td colspan="6" style="text-align: center; color: #999;">No recent fills</td></tr>' : ''}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">Recent Settlements</div>
                    <button class="expand-btn" onclick="openTableModal('settlements')" title="Expand">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="15 3 21 3 21 9"></polyline>
                            <polyline points="9 21 3 21 3 15"></polyline>
                            <line x1="21" y1="3" x2="14" y2="10"></line>
                            <line x1="3" y1="21" x2="10" y2="14"></line>
                        </svg>
                    </button>
                </div>
                <div class="table-scroll-wrapper" id="settlements-scroll-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Ticker</th>
                                <th>Result</th>
                                <th>Payout</th>
                            </tr>
                        </thead>
                        <tbody id="settlements-table-body">
                            ${settlements.length === 0 ? '<tr><td colspan="4" style="text-align: center; color: #999;">No recent settlements</td></tr>' : ''}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Table Modal -->
        <div class="table-modal" id="table-modal" onclick="if(event.target === this) closeTableModal()">
            <div class="table-modal-content">
                <div class="table-modal-header">
                    <div class="table-modal-title" id="table-modal-title">Table</div>
                    <button class="table-modal-close" onclick="closeTableModal()">&times;</button>
                </div>
                <div class="table-modal-body" id="table-modal-body"></div>
            </div>
        </div>
    `;

    // Populate fills table
    const fillsBody = document.getElementById('fills-table-body');
    if (fills.length > 0) {
        fillsBody.innerHTML = fills.map(renderFillRow).join('');
    }

    // Populate settlements table
    const settlementsBody = document.getElementById('settlements-table-body');
    if (settlements.length > 0) {
        settlementsBody.innerHTML = settlements.map(renderSettlementRow).join('');
    }

    // Render cumulative returns chart
    if (data.returns_over_time && data.returns_over_time.length > 0) {
        renderCumulativeChart(data.returns_over_time);
    }

    // Setup scroll listeners for lazy loading
    setupScrollListeners();
}

function setupScrollListeners() {
    const fillsWrapper = document.getElementById('fills-scroll-wrapper');
    const settlementsWrapper = document.getElementById('settlements-scroll-wrapper');

    if (fillsWrapper) {
        fillsWrapper.addEventListener('scroll', () => {
            if (loadingFills || !hasMoreFills) return;
            const { scrollTop, scrollHeight, clientHeight } = fillsWrapper;
            if (scrollTop + clientHeight >= scrollHeight - 50) {
                loadMoreFills();
            }
        });
    }

    if (settlementsWrapper) {
        settlementsWrapper.addEventListener('scroll', () => {
            if (loadingSettlements || !hasMoreSettlements) return;
            const { scrollTop, scrollHeight, clientHeight } = settlementsWrapper;
            if (scrollTop + clientHeight >= scrollHeight - 50) {
                loadMoreSettlements();
            }
        });
    }
}

async function loadMoreFills() {
    if (loadingFills || !hasMoreFills || !fillsCursor) return;
    loadingFills = true;

    const tbody = document.getElementById('fills-table-body');
    tbody.insertAdjacentHTML('beforeend', '<tr class="load-more-row" id="fills-loading"><td colspan="6"><span class="loading-more"></span>Loading...</td></tr>');

    try {
        const response = await fetch(`/api/market/fills?cursor=${encodeURIComponent(fillsCursor)}`);
        const data = await response.json();

        document.getElementById('fills-loading')?.remove();

        if (data.success && data.fills && data.fills.length > 0) {
            tbody.insertAdjacentHTML('beforeend', data.fills.map(renderFillRow).join(''));

            fillsCursor = data.cursor || null;
            hasMoreFills = !!fillsCursor;
        } else {
            hasMoreFills = false;
        }
    } catch (e) {
        document.getElementById('fills-loading')?.remove();
        console.error('Error loading more fills:', e);
    }

    loadingFills = false;
}

async function loadMoreSettlements() {
    if (loadingSettlements || !hasMoreSettlements || !settlementsCursor) return;
    loadingSettlements = true;

    const tbody = document.getElementById('settlements-table-body');
    tbody.insertAdjacentHTML('beforeend', '<tr class="load-more-row" id="settlements-loading"><td colspan="4"><span class="loading-more"></span>Loading...</td></tr>');

    try {
        const response = await fetch(`/api/market/settlements?cursor=${encodeURIComponent(settlementsCursor)}`);
        const data = await response.json();

        document.getElementById('settlements-loading')?.remove();

        if (data.success && data.settlements && data.settlements.length > 0) {
            tbody.insertAdjacentHTML('beforeend', data.settlements.map(renderSettlementRow).join(''));

            settlementsCursor = data.cursor || null;
            hasMoreSettlements = !!settlementsCursor;
        } else {
            hasMoreSettlements = false;
        }
    } catch (e) {
        document.getElementById('settlements-loading')?.remove();
        console.error('Error loading more settlements:', e);
    }

    loadingSettlements = false;
}

// Modal state
let modalType = null;
let modalCursor = null;
let modalLoading = false;
let modalHasMore = true;

function openTableModal(type) {
    modalType = type;
    modalCursor = type === 'fills' ? fillsCursor : settlementsCursor;
    modalHasMore = type === 'fills' ? hasMoreFills : hasMoreSettlements;
    modalLoading = false;

    const modal = document.getElementById('table-modal');
    const title = document.getElementById('table-modal-title');
    const body = document.getElementById('table-modal-body');

    title.textContent = type === 'fills' ? 'All Fills' : 'All Settlements';

    // Clone the existing table data
    const sourceBody = document.getElementById(type === 'fills' ? 'fills-table-body' : 'settlements-table-body');
    const headers = type === 'fills'
        ? '<tr><th>Date</th><th>Ticker</th><th>Side</th><th>Qty</th><th>Price</th><th>Cost</th></tr>'
        : '<tr><th>Date</th><th>Ticker</th><th>Result</th><th>Payout</th></tr>';

    body.innerHTML = `
        <table class="data-table">
            <thead>${headers}</thead>
            <tbody id="modal-table-body">${sourceBody.innerHTML}</tbody>
        </table>
    `;

    modal.classList.add('active');
    document.body.style.overflow = 'hidden';

    // Setup scroll listener for modal
    body.addEventListener('scroll', handleModalScroll);
}

function closeTableModal() {
    const modal = document.getElementById('table-modal');
    const body = document.getElementById('table-modal-body');

    modal.classList.remove('active');
    document.body.style.overflow = '';
    body.removeEventListener('scroll', handleModalScroll);

    modalType = null;
    modalCursor = null;
}

function handleModalScroll(e) {
    if (modalLoading || !modalHasMore || !modalCursor) return;

    const { scrollTop, scrollHeight, clientHeight } = e.target;
    if (scrollTop + clientHeight >= scrollHeight - 50) {
        loadMoreModal();
    }
}

async function loadMoreModal() {
    if (modalLoading || !modalHasMore || !modalCursor) return;
    modalLoading = true;

    const tbody = document.getElementById('modal-table-body');
    const colspan = modalType === 'fills' ? 6 : 4;
    tbody.insertAdjacentHTML('beforeend', `<tr class="load-more-row" id="modal-loading"><td colspan="${colspan}"><span class="loading-more"></span>Loading...</td></tr>`);

    const endpoint = modalType === 'fills' ? '/api/market/fills' : '/api/market/settlements';

    try {
        const response = await fetch(`${endpoint}?cursor=${encodeURIComponent(modalCursor)}`);
        const data = await response.json();

        document.getElementById('modal-loading')?.remove();

        const items = modalType === 'fills' ? data.fills : data.settlements;

        if (data.success && items && items.length > 0) {
            const renderFn = modalType === 'fills' ? renderFillRow : renderSettlementRow;
            tbody.insertAdjacentHTML('beforeend', items.map(renderFn).join(''));
            modalCursor = data.cursor || null;
            modalHasMore = !!modalCursor;
        } else {
            modalHasMore = false;
        }
    } catch (e) {
        document.getElementById('modal-loading')?.remove();
        console.error('Error loading more in modal:', e);
    }

    modalLoading = false;
}

// Close modal on escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && document.getElementById('table-modal').classList.contains('active')) {
        closeTableModal();
    }
});

function renderCumulativeChart(returnsData) {
    const ctx = document.getElementById('cumulativeChart').getContext('2d');

    if (cumulativeChart) {
        cumulativeChart.destroy();
    }

    const labels = returnsData.map(d => d.date);
    const values = returnsData.map(d => d.cumulative_return / 100); // Convert cents to dollars

    cumulativeChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Cumulative Return ($)',
                data: values,
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                fill: true,
                tension: 0.3,
                pointRadius: values.length > 50 ? 0 : 2,
                pointHoverRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
                duration: 300
            },
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return '$' + context.parsed.y.toFixed(2);
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        maxTicksLimit: 10,
                        maxRotation: 0
                    }
                },
                y: {
                    grid: {
                        color: '#eee'
                    },
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toFixed(0);
                        }
                    }
                }
            }
        }
    });
}

// Load data on page load
document.addEventListener('DOMContentLoaded', loadDashboardData);
</script>
{% endblock %}
